<mah:MetroWindow x:Class="Azure.Costs.Ui.Wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:DataEstateOverview"
        xmlns:converters="clr-namespace:ValueConverters"
        mc:Ignorable="d"
        xmlns:gif="http://wpfanimatedgif.codeplex.com"
        xmlns:busyIndicator="https://github.com/Peoky/BusyIndicator"         
        xmlns:mah="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro" 
                 xmlns:scm="clr-namespace:System.ComponentModel;assembly=WindowsBase"
                 xmlns:dgx="clr-namespace:DataGridExtensions;assembly=DataGridExtensions"   
                 xmlns:oxy="http://oxyplot.org/wpf"
                 xmlns:oxycontrols="http://oxyplot.org/wpf/contrib"
        Title="Azure Data Costs" 
        Height="850" Width="1200"
        WindowStartupLocation="CenterScreen"
        GlowBrush="{DynamicResource MahApps.Brushes.Accent}"
        ResizeMode="CanResizeWithGrip"
        ShowIconOnTitleBar="True"
        Loaded="MetroWindow_Loaded"
        Icon="azure.ico">

    <mah:MetroWindow.Resources>

        <Style TargetType="{x:Type oxycontrols:LineSeries}" x:Key="MaxLineSeriesStyle">
            <Setter Property="Color" Value="Orange"/>
        </Style>

        <Style TargetType="{x:Type oxycontrols:LineSeries}" x:Key="AvgLineSeriesStyle">
            <Setter Property="Color" Value="Green"/>
        </Style>

        <Style TargetType="{x:Type ToolTip}" >
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="4"/>
        </Style>

        <SolidColorBrush Color="#F3F4F6" x:Key="LightestGreyHighlight"/>

        <Style TargetType="Image" x:Key="ButtonImageStyle">
            <Setter Property="Width" Value="18"/>
        </Style>

        <Style TargetType="TextBlock" x:Key="WarningTextBlockStyle">
            <Setter Property="Background" Value="Orange"/>
            <Setter Property="Opacity" Value="0.8"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
        </Style>

        <Style BasedOn="{StaticResource {x:Type DataGridRowHeader}}" TargetType="{x:Type DataGridRowHeader}">
            <Setter Property="Background" Value="White" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Height" Value="23" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="VerticalAlignment" Value="Top" />
        </Style>

        <Style TargetType="TextBlock" x:Key="SubSectionGridHeader">
            <Setter Property="FontSize" Value="16"></Setter>
        </Style>

        <Style TargetType="Expander">
            <Setter Property="Background" Value="{StaticResource LightestGreyHighlight}"/>
        </Style>

        <Style TargetType="{x:Type Image}" x:Key="LoadingGifStyle">
            <Setter Property="Height" Value="24"></Setter>
            <Setter Property="Width" Value="24"></Setter>
        </Style>

        <Style TargetType="Grid" x:Key="SubSectionGrid">
            <Setter Property="Background" Value="{StaticResource LightestGreyHighlight}"></Setter>
            <Setter Property="Margin" Value="0,8,0,0"></Setter>
        </Style>

        <converters:NonZeroNumberToBooleanConverter x:Key="NonZeroNumberToBooleanConverter"></converters:NonZeroNumberToBooleanConverter>

        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"></converters:InverseBooleanConverter>

        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"></BooleanToVisibilityConverter>

        <CollectionViewSource Source="{Binding DBTabVm.RestSqlDbList}" Filter="RestDbDataGridViewSource_Filter"  x:Key="RestDbDataGridViewSource">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="TotalCostBilling" Direction="Descending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        <CollectionViewSource Source="{Binding DFTabVm.DataFactoryList}" Filter="DataFactoryDataGridViewSource_Filter"  x:Key="DataFactoryDataGridViewSource">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="TotalCostBilling" Direction="Descending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        <CollectionViewSource Source="{Binding StorageTabVm.StorageList}" Filter="StorageDataGridViewSource_Filter"  x:Key="StorageDataGridViewSource">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="TotalCostBilling" Direction="Descending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        <CollectionViewSource Source="{Binding VNetTabVm.VNetList}" Filter="VNetDataGridViewSource_Filter"  x:Key="VNetDataGridViewSource">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="TotalCostBilling" Direction="Descending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        <CollectionViewSource Source="{Binding VmTabVm.VMList}" Filter="VMDataGridViewSource_Filter"  x:Key="VMDataGridViewSource">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="TotalCostBilling" Direction="Descending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        <CollectionViewSource Source="{Binding PurviewTabVm.PurviewList}" Filter="PurviewDataGridViewSource_Filter"  x:Key="PurviewDataGridViewSource">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="TotalCostBilling" Direction="Descending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        <CollectionViewSource Source="{Binding CosmosTabVm.CosmosList}" Filter="CosmosDataGridViewSource_Filter"  x:Key="CosmosDataGridViewSource">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="TotalCostBilling" Direction="Descending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        

        <Style TargetType="{x:Type DataGridCell}" x:Key="DataGridParentCell">
            <Setter Property="FontSize" Value="13"></Setter>
        </Style>


        <Style TargetType="DataGrid">
            <Style.Setters>
                <Setter Property="CanUserAddRows" Value="False"/>
                <Setter Property="VerticalGridLinesBrush" Value="LightGray"/>
                <Setter Property="HorizontalGridLinesBrush" Value="LightGray"/>


                <Setter Property="AutoGenerateColumns" Value="False"/>
                <Setter Property="IsReadOnly" Value="True"/>
                <Setter Property="RowHeight" Value="20"/>
                <Setter Property="SelectionMode" Value="Extended"/>
                <Setter Property="SelectionUnit" Value="Cell"/>
                <Setter Property="CanUserResizeRows" Value="False"/>
                <Setter Property="VirtualizingStackPanel.IsVirtualizing" Value="true" />
                <Setter Property="EnableRowVirtualization"  Value="True"/>
                <Setter Property="RowDetailsVisibilityMode"  Value="Collapsed"/>
            </Style.Setters>
        </Style>

        <Style TargetType="DataGridCell" x:Key="NumericGridCellStyle">
            <Setter Property="HorizontalAlignment" Value="Right" />
        </Style>

        <Style TargetType="TextBlock" x:Key="TitleTextStyle">
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="DemiBold"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </mah:MetroWindow.Resources>
    <Grid>

        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <mah:MetroAnimatedSingleRowTabControl Name="MainTabControl" SelectionChanged="MainTabControl_SelectionChanged">

            <mah:MetroTabItem Header="Subscriptions" Name="TabSettings">

                <busyIndicator:BusyMask x:Name="IsGetSubscriptionsBusy" IsBusy="{Binding IsRestQueryBusy, FallbackValue=False}" IndicatorType="{Binding BusyIndicatorType}"  BusyContent="Please wait..." >

                    <Grid Margin="4,2,4,2">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Margin="2,8,2,8" FontSize="14" Padding="6" Background="LightGray">Test you are logged into Azure via CLI or Visual Studio</TextBlock>

                        <StackPanel Orientation="Horizontal" Grid.Row="1">

                            <TextBlock Margin="6,2,2,2" VerticalAlignment="Center">Access Method:</TextBlock>
                            
                            <ComboBox Margin="2" Name="AccessmethodCombo" Width="110" SelectionChanged="AccessmethodCombo_SelectionChanged">

                                <ComboBoxItem IsSelected="True">Azure CLI</ComboBoxItem>
                                <ComboBoxItem >Visual Studio</ComboBoxItem>
                                
                            </ComboBox>
                            
                            <Button Margin="2" VerticalAlignment="Center" Name="TestLoginButton" Click="TestLoginButton_Click">Login</Button>
                        </StackPanel>

                        <TextBlock Name="LoggedInOkMessageText" Margin="2" Padding="6" Grid.Row="2" Background="GhostWhite" Opacity=".8"
                    Visibility="{Binding TestLoginErrorMessage, Converter={converters:InverseStringNullOrEmptyToVisibilityConverter}}"
                    >You are logged in</TextBlock>

                        <StackPanel Grid.Row="2" Visibility="{Binding TestLoginErrorMessage, Converter={converters:StringNullOrEmptyToVisibilityConverter}}" >
                            <TextBlock Margin="2,2,2,0" 
                        Style="{StaticResource WarningTextBlockStyle}"
                    
             >You are NOT logged in. Either log in via visual studio OR use Azure CLI: az login</TextBlock>

                            <StackPanel Visibility="{Binding TestLoginErrorMessage, Converter={converters:StringNullOrEmptyToVisibilityConverter}}" >
                                <TextBlock Margin="2,0,2,0" Grid.Row="2" 
                            Style="{StaticResource WarningTextBlockStyle}" 
                            Text="{Binding TestLoginErrorMessage}"
                    
             ></TextBlock>

                            </StackPanel>
                        </StackPanel>


                        <Grid Grid.Row="3">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <TextBlock Margin="0,18,2,0" FontSize="13" Padding="6" Background="LightGray">Detected Subscriptions - There are caps on the amount of calls per minute/hour that can be made for objects and costs so only request what you need</TextBlock>

                            <DataGrid Grid.Row="1" IsReadOnly="True" x:Name="SubscriptionsGrid" 
                       AutoGenerateColumns="False" 
                       ItemsSource="{Binding DetectedSubscriptions}" 
                       local:DataGridExtensions.SortDesc="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Subscription Name"  Binding="{Binding displayName}" ></DataGridTextColumn>
                                    <DataGridTextColumn Header="Id"  Binding="{Binding subscriptionId}" ></DataGridTextColumn>
                                    <DataGridTextColumn Header="TenantId" Visibility="Collapsed" Binding="{Binding tenantId}" ></DataGridTextColumn>

                                    <DataGridTemplateColumn Header="Select">

                                        <DataGridTemplateColumn.HeaderTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Margin="1,1,4,1">Select</TextBlock>
                                                    <CheckBox IsChecked="{Binding DataContext.ReadAllObjectsCheck, RelativeSource={RelativeSource AncestorType=DataGrid}}" ></CheckBox>
                                                </StackPanel>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.HeaderTemplate>

                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <CheckBox HorizontalAlignment="Center" IsChecked="{Binding ReadObjects, UpdateSourceTrigger=PropertyChanged}" Unchecked="IgnoreCheckBox_Checked" Checked="IgnoreCheckBox_Checked" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Visibility="Collapsed" Header="Read Costs">

                                        <DataGridTemplateColumn.HeaderTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Margin="1,1,4,1">Read Costs</TextBlock>
                                                    <CheckBox IsChecked="{Binding DataContext.ReadAllCostsCheck, RelativeSource={RelativeSource AncestorType=DataGrid}}" ></CheckBox>
                                                </StackPanel>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.HeaderTemplate>

                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <CheckBox HorizontalAlignment="Center" IsChecked="{Binding ReadCosts, UpdateSourceTrigger=PropertyChanged}" Unchecked="IgnoreCheckBox_Checked" Checked="IgnoreCheckBox_Checked" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTextColumn Header="Errors" Binding="{Binding CostsErrorMessage}"></DataGridTextColumn>

                                </DataGrid.Columns>
                            </DataGrid>

                        </Grid>

                    </Grid>
                </busyIndicator:BusyMask>
            </mah:MetroTabItem>

            <mah:MetroTabItem Header="SQL Databases" Name="TabRest">

                <busyIndicator:BusyMask TargetUpdated="BusyIndicatorSql_TargetUpdated" 
                                        SourceUpdated="BusyIndicatorSql_SourceUpdated" 
                                        x:Name="BusyIndicatorSql" 
                                        IsBusy="{Binding DBTabVm.IsGetSqlServersBusy}" 
                                        IndicatorType="{Binding BusyIndicatorType}" 
                                        BusyContent="Please wait..." >
                    
                    <Grid Name="AzureSqlLayoutGrid" IsVisibleChanged="AzureSqlLayoutGrid_IsVisibleChanged" >

                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto" MaxHeight="40"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal" Margin="4,6,4,6">

                            <TextBlock Margin="6,2,2,2" Text="Filter:" VerticalAlignment="Center"></TextBlock>
                            <TextBox Margin="4,2,2,2" Width="180" Name="RestDbFilterText" VerticalAlignment="Center" KeyUp="RestDbFilterText_KeyUp" TextChanged="RestDbFilterText_TextChanged"></TextBox>

                            <TextBlock Margin="22,2,2,2" Text="Cost Days:" VerticalAlignment="Center"></TextBlock>
                            <TextBox Margin="4,2,2,2" Width="40" Name="CostDaysText" VerticalAlignment="Center" PreviewTextInput="CostDaysText_PreviewTextInput" ></TextBox>

                            <!--<Button Margin="22,2,2,2" VerticalAlignment="Center" Name="GroupButton" Click="GroupButton_Click" IsEnabled="{Binding IsGetSqlServersBusy, Converter={StaticResource InverseBooleanConverter}}">Group</Button>-->

                            <!--<Button x:Name="RestConfigButton" Margin="12,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="RestConfigButton_Click">Configure</Button>-->

                            <Button x:Name="RestRefreshButton" Margin="10,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="DBRefreshButton_Click" IsEnabled="{Binding DBTabVm.IsGetSqlServersBusy, Converter={StaticResource InverseBooleanConverter}}">
                                <StackPanel Orientation="Horizontal" >

                                    <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                </StackPanel>
                            </Button>

                        </StackPanel>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="4,6,4,6">

                            <TextBlock Margin="8,2,2,2" FontSize="14" VerticalAlignment="Center">Total SQL DB Costs:</TextBlock>
                            <TextBlock Margin="4,2,2,2" FontSize="14" VerticalAlignment="Center" Text="{Binding DBTabVm.TotalSqlDbCostsText}"></TextBlock>

                            <Button x:Name="DBAnalyseSpendButton" Margin="28,2,2,2" Padding="8,1,8,1" Click="DBAnalyseSpendButton_Click" >
                                <StackPanel Orientation="Horizontal" >

                                    <Image Source="/AzureDataCosts;component/Images/zoom.png" Style="{StaticResource ButtonImageStyle}"/>
                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">ANALYSE SPEND</TextBlock>
                                </StackPanel>
                            </Button>

                            <Image Margin="2,2,8,2">
                                <Image.Style>
                                    <Style TargetType="Image" BasedOn="{StaticResource HelpImageStyle}">

                                        <Setter Property="ToolTip">
                                            <Setter.Value>
                                                <StackPanel>
                                                    <TextBlock FontWeight="Bold" FontStyle="Italic">Spend Analysis</TextBlock>

                                                    <TextBlock Margin="1,4,1,0">  
        <LineBreak/>
        Maximum DTU or VCore usage over the previous x days (set in box above) is found.
        <LineBreak/><LineBreak/>
        This is used to calculate by what % a database is over provisioned.
        <LineBreak/><LineBreak/>                                                                
        This % is used to calculate if the database can be downgraded to a lower service tier.
        <LineBreak/><LineBreak/>
        Finally the financial saving of lowering service tier is calculated.
        <LineBreak/><LineBreak/>
        Look at the 'Over Provision%' and 'Potential Saving' columns for details.

                                                    </TextBlock>
                                                </StackPanel>
                                            </Setter.Value>
                                        </Setter>

                                    </Style>
                                </Image.Style>
                            </Image>

                            <Image gif:ImageBehavior.AnimatedSource="/Images/loading.gif" 
                                Margin="8,0,0,0" 
                                Style="{StaticResource LoadingGifStyle}"
                                Visibility="{Binding DBTabVm.IsDbSpendAnalysisBusy,Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Image.LayoutTransform>
                                    <ScaleTransform ScaleX="0.8" ScaleY="0.8" />
                                </Image.LayoutTransform>
                            </Image>

                            <TextBlock Margin="30,2,2,2" FontSize="14" VerticalAlignment="Center" Visibility="{Binding DBTabVm.HasDbSpendAnalysisBeenPerformed, Converter={StaticResource BooleanToVisibilityConverter}}">Total Potential Saving:</TextBlock>
                            <TextBlock Margin="4,2,2,2" FontSize="14" VerticalAlignment="Center" Text="{Binding DBTabVm.TotalPotentialDbSavingAmount, StringFormat=N0}" Visibility="{Binding DBTabVm.HasDbSpendAnalysisBeenPerformed, Converter={ StaticResource BooleanToVisibilityConverter}}"></TextBlock>


                            <Button x:Name="DBRecomendationsButton" Margin="28,2,2,2" Padding="8,1,8,1" Click="DBRecomendationsButton_Click" >
                                <StackPanel Orientation="Horizontal" >

                                    <Image Source="/AzureDataCosts;component/Images/recommendations.png" Style="{StaticResource ButtonImageStyle}"/>
                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center" Name="DbRecsButtonText" Text="{Binding DBTabVm.DbRecsButtonText}"></TextBlock>
                                </StackPanel>
                            </Button>
                        </StackPanel>

                        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="4,4,4,4" Visibility="{Binding IsRestErrorMessageVisible, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}">

                            <!--<TextBlock Margin="2,39,2,0" 
                                   Style="{StaticResource WarningTextBlockStyle}" 
                                   Text="{Binding TestLoginErrorMessage}" 
                                   Visibility="{Binding TestLoginErrorMessage, Converter={converters:StringNullOrEmptyToVisibilityConverter}, FallbackValue=Collapsed}" 
                                   />-->

                            <TextBlock Margin="2,2,2,2" Padding="6" Text="{Binding DBTabVm.RestErrorMessage}" MaxHeight="160" ToolTip="{Binding DBTabVm.RestErrorMessage}" ToolTipService.InitialShowDelay="0" 
                                  Background="Orange" ></TextBlock>

                        </StackPanel>



                        <DataGrid x:Name="RestDbDataGrid"
                                  Grid.Row="3"
                                  Margin="0,8,0,0" 
                                  ItemsSource="{Binding Source={StaticResource RestDbDataGridViewSource}}" 
                                  FrozenColumnCount ="1"
                                  MouseUp="RestDbDataGrid_MouseUp"
                                  KeyDown="RestDbDataGrid_KeyDown"
                                  MouseDoubleClick="RestDbDataGrid_MouseDoubleClick"
                                  ClipboardCopyMode="IncludeHeader"   
                                  SelectionChanged="RestDbDataGrid_SelectionChanged"
                                  LoadingRowDetails="RestDbDataGrid_LoadingRowDetails"
                                  local:DataGridExtensions.SortDesc="True"
                                  ScrollViewer.CanContentScroll="False"
                            >


                            <DataGrid.RowStyle>
                                <Style TargetType="{x:Type DataGridRow}">
                                    <EventSetter Event="MouseDoubleClick" Handler="RowDoubleClick"/>
                                    <!--<EventSetter Event="PreviewMouseLeftButtonDown" Handler="SelectRowDetails"/>-->
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="SQL Details" Click="RestGridMenuItemSqlDetails_Click" />
                                    <MenuItem Header="Refresh DB" Click="RestGridMenuItemRefresh_Click" />
                                </ContextMenu>
                            </DataGrid.ContextMenu>

                            <DataGrid.CellStyle>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="BorderThickness" Value="0"/>
                                </Style>
                            </DataGrid.CellStyle>

                            <DataGrid.RowHeaderTemplate>
                                <DataTemplate>
                                    <Expander VerticalAlignment="Top" Margin="0" Padding="0" Expanded="Expander_Process"  Collapsed="Expander_Process" Cursor="Hand">
                                    </Expander>
                                </DataTemplate>
                            </DataGrid.RowHeaderTemplate>

                            <DataGrid.Columns>

                                <DataGridTextColumn Header="DB"  Binding="{Binding name}"></DataGridTextColumn>

                                <DataGridTextColumn Binding="{Binding serverName}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Server" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
                                                       Foreground="DarkOrange"
                                                       Text="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.ServerFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.ServerFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding Subscription.displayName}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Subscription" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
                                                       Foreground="DarkOrange"
                                                       Text="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.SubscriptionFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.SubscriptionFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Service Objective"  Binding="{Binding properties.currentServiceObjectiveName}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Service Objective" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
                                                       Foreground="DarkOrange"
                                                       Text="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.SoFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.SoFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>

                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Cost (Bill CCY)"  Binding="{Binding TotalCostBilling, StringFormat={}{0:0.#0;(0);'?'}}" >

                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TotalCostBilling, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=20, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>

                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Over Provision%"  Binding="{Binding OverSpendFromMaxPc, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}" local:DataGridExtensions.SortDesc="True" />
                                <DataGridTextColumn Header="Potential Saving"  Binding="{Binding PotentialSavingAmount, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}" local:DataGridExtensions.SortDesc="True" />
                                <DataGridTextColumn Header="Saving Description"  Binding="{Binding PotentialSavingDescription}" />

                                <DataGridTextColumn Header="DTU %"  Binding="{Binding dtu_consumption_percent, StringFormat=N0}" local:DataGridExtensions.SortDesc="True" >
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding dtu_consumption_percent, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=75, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Sessions"  Binding="{Binding sessions_count}" CellStyle="{StaticResource NumericGridCellStyle}" local:DataGridExtensions.SortDesc="True" />

                                <DataGridTextColumn Header="Size Limit GB"  Binding="{Binding currentDbSizeLimitGb, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}" local:DataGridExtensions.SortDesc="True" />

                                <DataGridTextColumn Header="Allocated GB"  Binding="{Binding currentAllocatedDbSizeGb, StringFormat=N2}" CellStyle="{StaticResource NumericGridCellStyle}" local:DataGridExtensions.SortDesc="True" />

                                <DataGridTextColumn Header="Used GB"  Binding="{Binding currentDbSizeGb, StringFormat=N2}" CellStyle="{StaticResource NumericGridCellStyle}" local:DataGridExtensions.SortDesc="True" />

                                <DataGridTextColumn Header="Used GB %"  Binding="{Binding currentDbSizeUsedPc, StringFormat=N2}" local:DataGridExtensions.SortDesc="True">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding currentDbSizeUsedPc, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=75, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Elastic Pool"  Binding="{Binding properties.elasticPoolName}" ></DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding location}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Location" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
                       Foreground="DarkOrange"
                       Text="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.LocationFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.LocationFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Secondary Location"  Binding="{Binding properties.defaultSecondaryLocation}" ></DataGridTextColumn>

                                <DataGridTextColumn Header="Tags" Width="220" Binding="{Binding TagsString}">
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid >
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Tags" TextWrapping="Wrap" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" >
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
                                                               Foreground="DarkOrange"
                                                               Text="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.TagsFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=RestDbDataGrid, Path=DataContext.DBTabVm.TagsFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>

                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" >
                                            <Setter Property="ToolTip" Value="{Binding TagsStringMultiLine}"/>
                                            <Setter Property="ToolTipService.InitialShowDelay" Value="0"/>
                                            <Setter Property="IsEnabled" Value="True"/>
                                            <Setter Property="IsEditing" Value="True"/>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Zone Redundant"  Binding="{Binding properties.zoneRedundant}" ></DataGridTextColumn>
                                <DataGridTextColumn Header="Backup Storage Redundancy"  Binding="{Binding properties.currentBackupStorageRedundancy}" ></DataGridTextColumn>



                                <!--<DataGridTextColumn Header="Monthly Cost"  Binding="{Binding MonthlyCost}" ></DataGridTextColumn>

                            <DataGridTextColumn Header="Elastic Pool"  Binding="{Binding ElasticPoolName}" ></DataGridTextColumn>-->

                                <DataGridTextColumn Header="Earliest Restore Date"  Binding="{Binding properties.earliestRestoreDate}" ></DataGridTextColumn>

                                <DataGridTextColumn Header="LTR Monthly Retention"  Binding="{Binding lTRPolicyProperties.monthlyRetention}" CellStyle="{StaticResource NumericGridCellStyle}"  ></DataGridTextColumn>
                                <DataGridTextColumn Header="LTR Week Of Year"  Binding="{Binding lTRPolicyProperties.weekOfYear}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>
                                <DataGridTextColumn Header="LTR Weekly Retention"  Binding="{Binding lTRPolicyProperties.weeklyRetention}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>
                                <DataGridTextColumn Header="LTR Yearly Retention"  Binding="{Binding lTRPolicyProperties.yearlyRetention}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>

                                <DataGridTextColumn Header="Vuln Scan Time"  Binding="{Binding latestVulnerabilityScanProperties.endTime}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>
                                <DataGridTextColumn Header="Vuln Scan State"  Binding="{Binding latestVulnerabilityScanProperties.state}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>
                                <DataGridTextColumn Header="Vuln Scan Failed Sec Checks"  Binding="{Binding latestVulnerabilityScanProperties.numberOfFailedSecurityChecks}"  >
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding latestVulnerabilityScanProperties.numberOfFailedSecurityChecks, ConverterParameter=1, Converter={StaticResource NonZeroNumberToBooleanConverter}, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Vuln Scan Error" Width="90" Foreground="OrangeRed"  Binding="{Binding VulnerabilityScanError}" ></DataGridTextColumn>

                                <DataGridTextColumn Header="Advisor Recommendations" Binding="{Binding AdvisorRecommendationCount, StringFormat=N0}" >

                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">

                                            <Style.Setters>
                                                <EventSetter Event="GotFocus" Handler="RecoCellClick"/>

                                                <Setter Property="ToolTip" Value="{Binding advisorRecommendationDetails}"/>
                                                <Setter Property="Cursor" Value="Hand"/>
                                            </Style.Setters>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding AdvisorRecommendationCount, ConverterParameter=1, Converter={StaticResource NonZeroNumberToBooleanConverter}, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Recommendations Error" Width="140" Foreground="OrangeRed"  Binding="{Binding RecommendationsError}" ></DataGridTextColumn>

                                <DataGridTextColumn Header="Physical Read %"  Binding="{Binding physical_data_read_percent, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}"  local:DataGridExtensions.SortDesc="True" />
                                <DataGridTextColumn Header="Log Write %"  Binding="{Binding log_write_percent, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}"  local:DataGridExtensions.SortDesc="True" />
                                <!--<DataGridTextColumn Header="Storage %"  Binding="{Binding storage_percent, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}"  />-->
                                <DataGridTextColumn Header="Workers %"  Binding="{Binding workers_percent, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}"  local:DataGridExtensions.SortDesc="True" />
                                <DataGridTextColumn Header="Sessions %"  Binding="{Binding sessions_percent, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}"  local:DataGridExtensions.SortDesc="True" />
                                <DataGridTextColumn Header="SqlServer Proc Core %"  Binding="{Binding sqlserver_process_core_percent, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}"   local:DataGridExtensions.SortDesc="True"/>
                                <DataGridTextColumn Header="SqlServer Proc Mem %"  Binding="{Binding sqlserver_process_memory_percent, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}"  local:DataGridExtensions.SortDesc="True" />

                                <DataGridTextColumn Header="UserHasSelectPermission"  Binding="{Binding AzDB.UserHasSelectPermission}"  local:DataGridExtensions.SortDesc="True" />

                                <DataGridTextColumn Header="Scanned By Purview"  Binding="{Binding IsScannedByPurview}"  local:DataGridExtensions.SortDesc="True" />

                                

                                <!--<DataGridTextColumn Header="Storage"  Binding="{Binding storage}" CellStyle="{StaticResource NumericGridCellStyle}"  />
                            <DataGridTextColumn Header="DTU Limit"  Binding="{Binding dtu_limit}" CellStyle="{StaticResource NumericGridCellStyle}"  />
                            <DataGridTextColumn Header="DTU Used"  Binding="{Binding dtu_used}" CellStyle="{StaticResource NumericGridCellStyle}"  />-->

                                <!--tempdb metrics seem to be broken even in the portal so removing for now-->
                                <!--DataGridTextColumn Header="Tempdb Log Used %"  Binding="{Binding tempdb_log_used_percent, StringFormat=N2}" CellStyle="{StaticResource NumericGridCellStyle}"  />
                            <DataGridTextColumn Header="TempDB Data Size"  Binding="{Binding tempdb_data_size, StringFormat=N2}" CellStyle="{StaticResource NumericGridCellStyle}"  />
                            <DataGridTextColumn Header="TempDB Log Size"  Binding="{Binding tempdb_log_size, StringFormat=N2}" CellStyle="{StaticResource NumericGridCellStyle}"  /-->

                                <!--<DataGridTextColumn Header="Storage MB"  Binding="{Binding StorageMB}" CellStyle="{StaticResource NumericGridCellStyle}"  ></DataGridTextColumn>
                        <DataGridTextColumn Header="Avg Cpu %"  Binding="{Binding AvgCpuPc}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>
                        <DataGridTextColumn Header="Avg Data Io %"  Binding="{Binding AvgDataIoPc}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>
                        <DataGridTextColumn Header="Avg LogWrite %"  Binding="{Binding AvgLogWritePc}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>
                        <DataGridTextColumn Header="Max Worker %"  Binding="{Binding MaxWorkerPc}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>
                        <DataGridTextColumn Header="Max Session %"  Binding="{Binding MaxSessionPc}" CellStyle="{StaticResource NumericGridCellStyle}" ></DataGridTextColumn>-->
                            </DataGrid.Columns>

                            <DataGrid.RowDetailsTemplate>
                                <DataTemplate>

                                    <mah:MetroAnimatedSingleRowTabControl Name="DBTabControl" SelectionChanged="DBTabControl_SelectionChanged" Margin="0,0,0,30" >

                                        <mah:MetroTabItem Header="Useage" Name="TabDbUseage">

                                            <Grid Style="{StaticResource SubSectionGrid}">


                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>

                                                </Grid.RowDefinitions>

                                                <StackPanel Orientation="Horizontal" Margin="2,2,2,8">

                                                    <TextBlock Margin="4,2,0,2" Text="Last" VerticalAlignment="Center"></TextBlock>
                                                    <TextBox Height="22" Width="30" Name="DbCostDaysTextBox" VerticalContentAlignment="Center" Padding="0" VerticalAlignment="Center" Margin="6,2,2,2" 
                                                             Text="{Binding MetricsHistoryDays, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                             MouseDoubleClick="NonGridExpandingTextBox_MouseDoubleClick"
                                                             PreviewMouseDoubleClick="NonGridExpandingTextBox_MouseDoubleClick"
                                                             ></TextBox>
                                                    <TextBlock Margin="4,2,2,2" Text="Days" VerticalAlignment="Center"></TextBlock>

                                                    <Button x:Name="RefreshDbStatsButton" Margin="8,2,2,2" PreviewMouseLeftButtonDown="RefreshDbStatsButton_PreviewMouseLeftButtonDown" >
                                                        <StackPanel Orientation="Horizontal" >

                                                            <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                                            <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                                        </StackPanel>
                                                    </Button>

                                                    <Button x:Name="ViewPortalDbButton" Margin="8,2,2,2" PreviewMouseLeftButtonDown="ViewPortalDbButton_PreviewMouseLeftButtonDown" >
                                                        <StackPanel Orientation="Horizontal" >

                                                            <Image Source="/AzureDataCosts;component/Images/azure.png" Style="{StaticResource ButtonImageStyle}"/>
                                                            <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">AZURE PORTAL</TextBlock>
                                                        </StackPanel>
                                                    </Button>

                                                </StackPanel>

                                                <Grid Grid.Row="1">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                        </Grid.RowDefinitions>

                                                        <Border BorderThickness="0,0,0,1" BorderBrush="Gray">
                                                            <StackPanel Orientation="Horizontal" Margin="2">
                                                                <TextBlock Margin="2" Style="{StaticResource SubSectionGridHeader}" VerticalAlignment="Center">Database Usage</TextBlock>

                                                            </StackPanel>
                                                        </Border>

                                                        <StackPanel Orientation="Horizontal" Margin="8" Grid.Row="1">
                                                            <TextBlock Margin="2">Max DTU/CPU % found:</TextBlock>
                                                            <TextBlock Margin="2" Text="{Binding MaxDtuUsed}"></TextBlock>

                                                            <TextBlock Margin="30,2,2,2" Text="{Binding MetricsErrorMessage}"></TextBlock>
                                                        </StackPanel>

                                                        <busyIndicator:BusyMask Grid.Row="2"
                                                            IsBusy="{Binding IsRestQueryBusy, FallbackValue=False}" 
                                                            IndicatorType="{Binding BusyIndicatorType}"
                                                            BusyContent="Please wait..." >

                                                            <Grid>
                                                             
                                                                <oxycontrols:Plot Grid.Column="1" Height="150" Width="360" VerticalAlignment="Top">

                                                                    <oxycontrols:Plot.Legends>
                                                                        <oxycontrols:Legend LegendPosition="RightMiddle" LegendPlacement="Outside" />
                                                                    </oxycontrols:Plot.Legends>
                                                                    
                                                                    <oxycontrols:Plot.Series>

                                                                        <oxycontrols:LineSeries DisplayMemberPath="maximum" Title="Max"
                                                                                                Style="{StaticResource MaxLineSeriesStyle}"
                                                                                                DataFieldX="timeStamp" 
                                                                                                DataFieldY="maximum"
                                                                                                ItemsSource="{Binding PerformanceMetricSeries}"/>

                                                                        <oxycontrols:LineSeries DisplayMemberPath="average" Title="Avg"
                                                                            DataFieldX="timeStamp" 
                                                                            DataFieldY="average"
                                                                            Style="{StaticResource AvgLineSeriesStyle}"
                                                                            ItemsSource="{Binding PerformanceMetricSeries}"/>

                                                                    </oxycontrols:Plot.Series>

                                                                    <oxycontrols:Plot.Axes>
                                                                        <oxycontrols:LinearAxis Position="Left" Minimum="0" Maximum="100" />
                                                                        <oxycontrols:DateTimeAxis Position="Bottom"/>
                                                                    </oxycontrols:Plot.Axes>
                                                                </oxycontrols:Plot>
                                                                
                                                            </Grid>
                                                            

                                                        </busyIndicator:BusyMask>
                                                    </Grid>

                                                    <Grid Grid.Column="1" Visibility="{Binding IsElaticPoolMember, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}">
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                         
                                                        </Grid.RowDefinitions>

                                                        <Border BorderThickness="0,0,0,1" BorderBrush="Gray">
                                                            <TextBlock Margin="2,4,2,4" FontSize="16" VerticalAlignment="Center">Elastic Pool Usage</TextBlock>
                                                        </Border>

                                                        <StackPanel Orientation="Horizontal" Margin="2" Grid.Row="1">
                                                            <TextBlock Margin="8">Max DTU/CPU % found:</TextBlock>
                                                            <TextBlock Margin="2" Text="{Binding ElasticPool.MaxDtuUsed}" VerticalAlignment="Center"></TextBlock>

                                                            <TextBlock Margin="30,2,2,2" Text="{Binding ElasticPool.MetricsErrorMessage}"></TextBlock>
                                                        </StackPanel>

                                                        <busyIndicator:BusyMask Grid.Row="2"
                                                            IsBusy="{Binding IsRestQueryBusy, FallbackValue=False}" 
                                                            IndicatorType="{Binding BusyIndicatorType}"
                                                            BusyContent="Please wait..." >

                                                            <Grid>

                                                                <oxycontrols:Plot Height="150" Width="300" VerticalAlignment="Top" >
                                                                    <oxycontrols:Plot.Series>

                                                                        <oxycontrols:LineSeries DisplayMemberPath="maximum" 
                                                                            Style="{StaticResource MaxLineSeriesStyle}"
                                                                            DataFieldX="timeStamp" 
                                                                            DataFieldY="maximum"
                                                                            ItemsSource="{Binding ElasticPool.PerformanceMetricSeries}"/>

                                                                        <oxycontrols:LineSeries DisplayMemberPath="average" 
                                                                            DataFieldX="timeStamp" 
                                                                            DataFieldY="average"
                                                                            Style="{StaticResource AvgLineSeriesStyle}"
                                                                            ItemsSource="{Binding ElasticPool.PerformanceMetricSeries}"/>


                                                                    </oxycontrols:Plot.Series>

                                                                    <oxycontrols:Plot.Axes>
                                                                        <oxycontrols:LinearAxis Position="Left" Minimum="0" Maximum="100" />
                                                                        <oxycontrols:DateTimeAxis Position="Bottom"/>
                                                                    </oxycontrols:Plot.Axes>
                                                                </oxycontrols:Plot>
                                               
                                                            </Grid>
                                                            
                                                        </busyIndicator:BusyMask>

                                                    </Grid>

                                                </Grid>

                                            </Grid>

                                        </mah:MetroTabItem>

                                        <mah:MetroTabItem Header="Costs" Name="TabDbCosts">

                                            <Grid Style="{StaticResource SubSectionGrid}">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>

                                                <!--<Border BorderThickness="0,0,0,1" BorderBrush="Gray">
                                                    <StackPanel Orientation="Horizontal" Margin="2,2,2,2">
                                                        <TextBlock Margin="2" FontSize="16" VerticalAlignment="Center">Costs</TextBlock>

                                                    </StackPanel>
                                                </Border>-->

                                                <DataGrid Grid.Row="1" ItemsSource="{Binding Path=Costs}" AutoGenerateColumns="false" CanUserAddRows="False" local:DataGridExtensions.SortDesc="True">
                                                    <DataGrid.Columns>
                                                        
                                                        <!--<DataGridTextColumn Header="Meter Category" Binding="{Binding Path=MeterCategory}" IsReadOnly="True"/>
                                                        <DataGridTextColumn Header="Meter SubCategory" Binding="{Binding Path=MeterSubCategory}" IsReadOnly="True"/>-->
                                                        <DataGridTextColumn Header="Product" Binding="{Binding Path=Product}" IsReadOnly="True"/>
                                                        <DataGridTextColumn Header="Meter" Binding="{Binding Path=Meter}" IsReadOnly="True"/>
                                                        <!--<DataGridTextColumn Header="Service Name" Binding="{Binding Path=ServiceName}" IsReadOnly="True"/>
                                                        <DataGridTextColumn Header="Resource Type" Binding="{Binding Path=ResourceType}" IsReadOnly="True"/>-->

                                                        <DataGridTextColumn Header="Cost" Binding="{Binding Path=Cost, StringFormat={}{0:0.#0;(0);}}">
                                                            <DataGridTextColumn.CellStyle>
                                                                <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding Cost, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                                            <Setter Property="Foreground" Value="OrangeRed" />
                                                                            <Setter Property="FontWeight" Value="Bold" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </DataGridTextColumn.CellStyle>
                                                        </DataGridTextColumn>

                                                        <DataGridTextColumn Header="Charge Type" Binding="{Binding Path=ChargeType}" IsReadOnly="True"/>
                                                        <DataGridTextColumn Header="Currency" Binding="{Binding Path=Currency}" IsReadOnly="True"/>
                                                        <DataGridTextColumn Header="ResourceId" Binding="{Binding Path=ResourceId}" IsReadOnly="True"/>

                                                        
                                                    </DataGrid.Columns>
                                                </DataGrid>
                                            </Grid>

                                        </mah:MetroTabItem>

                                        <mah:MetroTabItem Header="Advisor" Name="TabDbAdvisor">

                                            <Grid HorizontalAlignment="Left"  Style="{StaticResource SubSectionGrid}">

                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>

                                                <TextBlock Margin="2,4,2,2" FontSize="16" VerticalAlignment="Center" Text="{Binding AdvisorRecommendationSummary}"/>


                                                <TextBox Margin="2,8,2,2" 
                                                         Visibility="{Binding HasAdvisorRecommendations, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"
                                                         Width="450" 
                                                         TextWrapping="Wrap" 
                                                         IsReadOnly="True"  
                                                         Grid.Row="1" 
                                                         Text="{Binding advisorRecommendationDetails}"/>
                                            </Grid>

                                        </mah:MetroTabItem>

                                        <mah:MetroTabItem Header="Live Status" Name="TabDbLiveStatus">

                                            <Grid Style="{StaticResource SubSectionGrid}" >

                                                <busyIndicator:BusyMask IsBusy="{Binding AzDB.IsQueryingDatabase, FallbackValue=False}" IndicatorType="{Binding BusyIndicatorType}"  BusyContent="Please wait..." >
                                                    <Grid Width="1100" Height="500" HorizontalAlignment="Left">
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="*"/>

                                                        </Grid.RowDefinitions>

                                                        <StackPanel Orientation="Horizontal" Margin="6">

                                                            <Button x:Name="SQLDBRefreshButton" Margin="10,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="SQLDBRefreshButton_Click" IsEnabled="{Binding AzDB.IsQueryingDatabase, Converter={StaticResource InverseBooleanConverter}}">
                                                                <StackPanel Orientation="Horizontal" >

                                                                    <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                                                </StackPanel>
                                                            </Button>

                                                        </StackPanel>

                                                        <TextBlock Grid.Row="1" Margin="2" Style="{StaticResource WarningTextBlockStyle}" 
                                                                   Visibility="{Binding AzDB.HasConnectivityError, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"
                                                                   Text="{Binding AzDB.ConnectivityError}" />


                                                        <Grid x:Name="ServerGrid" Grid.Row="2">
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height=".5*"/>
                                                                <RowDefinition Height="2"/>
                                                                <RowDefinition Height=".5*"/>

                                                            </Grid.RowDefinitions>

                                                            <Grid Grid.Row="2" x:Name="DatabaseGridx">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width=".9*"></ColumnDefinition>
                                                                    <ColumnDefinition Width="4" MaxWidth="4"></ColumnDefinition>
                                                                    <ColumnDefinition Width="*"></ColumnDefinition>
                                                                </Grid.ColumnDefinitions>

                                                                <Grid>
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="Auto"></RowDefinition>
                                                                        <RowDefinition Height="*"></RowDefinition>
                                                                    </Grid.RowDefinitions>

                                                                    <StackPanel Orientation="Horizontal" >
                                                                        <TextBlock Margin="8,4,4,4" VerticalAlignment="Center" Style="{StaticResource SubSectionGridHeader}" Text="Event Log: "></TextBlock>
                                                                    </StackPanel>

                                                                    <DataGrid Grid.Row="1" 
                                                                              IsReadOnly="True" 
                                                                              x:Name="DbEventLogGrid" 
                                                                               ItemsSource="{Binding Path=AzDB.EventLog}"
                                                                              AutoGenerateColumns="True" 
                                                                              local:DataGridExtensions.SortDesc="True">
                                                                        <!--<DataGrid.Columns>
    <DataGridTextColumn Header="col1"  Binding="{Binding DatabaseName}" ></DataGridTextColumn>
</DataGrid.Columns>-->
                                                                    </DataGrid>

                                                                </Grid>

                                                                <GridSplitter Grid.Column="1" Width="4" MaxWidth="4" Cursor="SizeWE" VerticalAlignment="Stretch" />

                                                                <Grid Grid.Column="2">
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="Auto"></RowDefinition>
                                                                        <RowDefinition Height="*"></RowDefinition>
                                                                    </Grid.RowDefinitions>


                                                                    <StackPanel Orientation="Horizontal" >
                                                                        <TextBlock Margin="8,4,4,4" VerticalAlignment="Center" Style="{StaticResource SubSectionGridHeader}" Text="SQL Sessions: "></TextBlock>

                                                                        <!--<CheckBox Margin="22,2,2,2" IsChecked="{Binding ShowRunningSessionsOnly}"></CheckBox>
                    <TextBlock Margin="0,4,4,4" VerticalAlignment="Center" FontSize="11" Text="Running Requests Only"></TextBlock>-->
                                                                    </StackPanel>

                                                                    <DataGrid Grid.Row="1" IsReadOnly="True" x:Name="DbRequestsGrid" 
                                                                          ItemsSource="{Binding Path=AzDB.Sessions}"
                                                                          AutoGenerateColumns="True" 
                                                                          CanUserResizeRows="False" 
                                                                          RowHeight="20" 
                                                                          local:DataGridExtensions.SortDesc="True">
                                                                        <!--<DataGrid.Columns>
                        <DataGridTextColumn Header="col1"  Binding="{Binding DatabaseName}" ></DataGridTextColumn>
                    </DataGrid.Columns>-->
                                                                    </DataGrid>
                                                                </Grid>

                                                            </Grid>

                                                            <GridSplitter Grid.Row="3" Height="2" MaxHeight="2" Cursor="SizeNS" HorizontalAlignment="Stretch" />

                                                            <Grid Grid.Row="4" x:Name="DatabaseGrid2">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width=".9*"></ColumnDefinition>
                                                                    <ColumnDefinition Width="4" MaxWidth="4"></ColumnDefinition>
                                                                    <ColumnDefinition Width="*"></ColumnDefinition>
                                                                </Grid.ColumnDefinitions>

                                                                <Grid>
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="Auto"></RowDefinition>
                                                                        <RowDefinition Height="*"></RowDefinition>
                                                                    </Grid.RowDefinitions>

                                                                    <StackPanel Orientation="Horizontal" >
                                                                        <TextBlock Margin="8,4,4,4" VerticalAlignment="Center" Style="{StaticResource SubSectionGridHeader}" Text="Logins: "></TextBlock>
                                                                    </StackPanel>

                                                                    <DataGrid Grid.Row="1" IsReadOnly="True" 
                                                                          x:Name="DbLoginsGrid" 
                                                                          ItemsSource="{Binding Path=AzDB.DBPrincipals}"
                                                                          AutoGenerateColumns="True" 
                                                                          local:DataGridExtensions.SortDesc="True">
                                                                        <!--<DataGrid.Columns>
    <DataGridTextColumn Header="col1"  Binding="{Binding DatabaseName}" ></DataGridTextColumn>
</DataGrid.Columns>-->
                                                                    </DataGrid>

                                                                </Grid>

                                                                <GridSplitter Grid.Column="1" Width="4" MaxWidth="4" Cursor="SizeWE" VerticalAlignment="Stretch" />

                                                                <Grid Grid.Column="2">
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="Auto"></RowDefinition>
                                                                        <RowDefinition Height="*"></RowDefinition>
                                                                    </Grid.RowDefinitions>


                                                                    <StackPanel Orientation="Horizontal" >
                                                                        <TextBlock Margin="8,4,4,4" VerticalAlignment="Center" Style="{StaticResource SubSectionGridHeader}" Text="Sync state: "></TextBlock>
                                                                    </StackPanel>

                                                                    <DataGrid Grid.Row="1" IsReadOnly="True" x:Name="DbSyncStateGrid" 
                                                                          ItemsSource="{Binding Path=AzDB.SyncStates}"
                                                                          AutoGenerateColumns="True" 
                                                                          local:DataGridExtensions.SortDesc="True">
                                                                        <!--<DataGrid.Columns>
    <DataGridTextColumn Header="col1"  Binding="{Binding DatabaseName}" ></DataGridTextColumn>
</DataGrid.Columns>-->
                                                                    </DataGrid>
                                                                </Grid>

                                                            </Grid>
                                                        </Grid>
                                                    </Grid>
                                                </busyIndicator:BusyMask>
                                            </Grid>

                                        </mah:MetroTabItem>

                                        <mah:MetroTabItem Header="Server" Name="TabDbServer">

                                            <Grid Style="{StaticResource SubSectionGrid}">
                                                <busyIndicator:BusyMask IsBusy="{Binding AzDB.IsQueryingDatabase, FallbackValue=False}" IndicatorType="{Binding BusyIndicatorType}"  BusyContent="Please wait..." >
                                                    <Grid Width="1100" Height="500" HorizontalAlignment="Left">
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="*"/>

                                                        </Grid.RowDefinitions>

                                                        <StackPanel Orientation="Horizontal" Margin="6">


                                                            <Button  Margin="10,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="SQLDBRefreshButton_Click" IsEnabled="{Binding AzDB.IsQueryingDatabase, Converter={StaticResource InverseBooleanConverter}}">
                                                                <StackPanel Orientation="Horizontal" >

                                                                    <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                                                </StackPanel>
                                                            </Button>
                                                        </StackPanel>

                                                        <TextBlock Grid.Row="1" Margin="1" Style="{StaticResource WarningTextBlockStyle}" 
                                                                       Text="{Binding AzDB.ParentAzServer.ConnectivityError}"
                                                                       Visibility="{Binding AzDB.ParentAzServer.HasConnectivityError, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"/>

                                                        <Grid x:Name="ServerGridA" Grid.Row="2">
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="*"/>

                                                            </Grid.RowDefinitions>

                                                            <Grid Grid.Row="1" x:Name="ServerGridx">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width=".5*"></ColumnDefinition>
                                                                    <ColumnDefinition Width="4"></ColumnDefinition>
                                                                    <ColumnDefinition Width=".5*"></ColumnDefinition>
                                                                </Grid.ColumnDefinitions>

                                                                <Grid>
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="Auto"></RowDefinition>
                                                                        <RowDefinition Height="*"></RowDefinition>
                                                                    </Grid.RowDefinitions>

                                                                    <StackPanel Orientation="Horizontal" >
                                                                        <TextBlock Margin="8,4,4,4" VerticalAlignment="Center" Style="{StaticResource SubSectionGridHeader}" Text="Event Log: "></TextBlock>
                                                                    </StackPanel>

                                                                    <DataGrid Grid.Row="1" 
                                                                              ItemsSource="{Binding AzDB.ParentAzServer.MasterDbEventLog}"
                                                                              IsReadOnly="True" 
                                                                              x:Name="ServerEventLogGrid" 
                                                                              AutoGenerateColumns="True" 
                                                                              local:DataGridExtensions.SortDesc="True">
                                                                        <!--<DataGrid.Columns>
    <DataGridTextColumn Header="col1"  Binding="{Binding DatabaseName}" ></DataGridTextColumn>
</DataGrid.Columns>-->
                                                                    </DataGrid>

                                                                </Grid>

                                                                <GridSplitter Grid.Column="1" Width="4" MaxWidth="4" Cursor="SizeWE" VerticalAlignment="Stretch" />

                                                                <Grid Grid.Column="2">
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="Auto"></RowDefinition>
                                                                        <RowDefinition Height="*"></RowDefinition>
                                                                    </Grid.RowDefinitions>

                                                                    <StackPanel Orientation="Horizontal" >
                                                                        <TextBlock Margin="8,4,4,4" VerticalAlignment="Center" Style="{StaticResource SubSectionGridHeader}" Text="Firewall Rules: "></TextBlock>
                                                                    </StackPanel>

                                                                    <DataGrid Grid.Row="1"  
                                                                              ItemsSource="{Binding AzDB.ParentAzServer.FireWallRules}"
                                                                              IsReadOnly="True" 
                                                                              x:Name="ServerFirewallGrid" 
                                                                              AutoGenerateColumns="True" 
                                                                              local:DataGridExtensions.SortDesc="True">
                                                                        <!--<DataGrid.Columns>
    <DataGridTextColumn Header="col1"  Binding="{Binding DatabaseName}" ></DataGridTextColumn>
</DataGrid.Columns>-->
                                                                    </DataGrid>

                                                                </Grid>

                                                            </Grid>

                                                        </Grid>
                                                    </Grid>
                                                </busyIndicator:BusyMask>
                                            </Grid>

                                        </mah:MetroTabItem>



                                    </mah:MetroAnimatedSingleRowTabControl>

                                </DataTemplate>
                            </DataGrid.RowDetailsTemplate>

                        </DataGrid>

                    </Grid>
                </busyIndicator:BusyMask>

            </mah:MetroTabItem>

            <mah:MetroTabItem Header="Cosmos" Name="TabCosmos">

                <busyIndicator:BusyMask IsBusy="{Binding CosmosTabVm.IsCosmosQueryBusy, FallbackValue=False}" IndicatorType="{Binding BusyIndicatorType}"  BusyContent="Please wait..." >

                    <Grid Name="CosmosLayoutGrid" IsVisibleChanged="CosmosLayoutGrid_IsVisibleChanged">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="47*"/>
                            <ColumnDefinition Width="1153*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal" Margin="4,4,4,4" Grid.ColumnSpan="2">

                            <Button x:Name="CosmosRefreshButton" Margin="10,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="CosmosRefreshButton_Click">
                                <StackPanel Orientation="Horizontal" >

                                    <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                </StackPanel>
                            </Button>

                            <Button x:Name="CosmosCollapseCostsButton" Margin="20,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="CosmosCollapseCostsButton_Click">Show/Collapse Costs</Button>

                            <TextBlock Margin="30,2,2,2" FontSize="14" VerticalAlignment="Center">Total Cosmos Costs:</TextBlock>
                            <TextBlock Margin="4,2,2,2" FontSize="14" VerticalAlignment="Center" Text="{Binding CosmosTabVm.TotalCostsText}"></TextBlock>
                        </StackPanel>

                        <TextBlock Grid.Row="1" 
                                   Margin="2,2,2,2" Grid.ColumnSpan="2" 
                                   Style="{StaticResource WarningTextBlockStyle}"
                                   Text="{Binding CosmosTabVm.RestErrorMessage}" 
                                   MaxHeight="150" 
                                   ToolTip="{Binding CosmosTabVm.RestErrorMessage}" ToolTipService.InitialShowDelay="0" 
                                   Visibility="{Binding CosmosTabVm.IsRestErrorMessage, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Hidden}" 
                                   ></TextBlock>

                        <DataGrid Grid.Row="2" x:Name="CosmosDataGrid"
                              VirtualizingStackPanel.IsVirtualizing="true" 
                                EnableRowVirtualization ="True"
                              ItemsSource="{Binding Source={StaticResource CosmosDataGridViewSource}}" 
                              AutoGenerateColumns="False"
                              CanUserResizeRows="False"
                              FrozenColumnCount ="1"
                              RowHeight="20"
                                MouseUp="VMDataGrid_MouseUp"
                                KeyDown="VMDataGrid_KeyDown"  
                              RowDetailsVisibilityMode="Collapsed"
                                  IsReadOnly="True" Grid.ColumnSpan="2"
                                local:DataGridExtensions.SortDesc="True"
                                  ScrollViewer.CanContentScroll="False"
                    >
                            <DataGrid.RowStyle>
                                <Style TargetType="{x:Type DataGridRow}">
                                    <EventSetter Event="MouseDoubleClick" Handler="RowDoubleClick"/>
                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="SelectRowDetails"/>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.CellStyle>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="BorderThickness" Value="0"/>
                                </Style>
                            </DataGrid.CellStyle>

                            <DataGrid.RowHeaderTemplate>
                                <DataTemplate>
                                    <Expander VerticalAlignment="Top" Margin="0" Padding="0" Expanded="Expander_Process"  Collapsed="Expander_Process">
                                    </Expander>
                                </DataTemplate>
                            </DataGrid.RowHeaderTemplate>

                            <DataGrid.Columns>

                                <DataGridTextColumn Header="Name" Binding="{Binding name}" CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn  Binding="{Binding resourceGroup}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Resource Group" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.ResourceGroupFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.ResourceGroupFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding Subscription.displayName}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Subscription" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.SubscriptionFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.SubscriptionFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Cost (Bill CCY)" Binding="{Binding TotalCostBilling, StringFormat={}{0:0.#0;(0);}}"  >
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}" >
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TotalCostBilling, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>

                                            <Setter Property="Background" Value="LightGray"></Setter>
                                            <Setter Property="FontSize" Value="13"></Setter>

                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="EnabledApiTypes"  Binding="{Binding properties.EnabledApiTypes}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="Enable Automatic Failover"  Binding="{Binding properties.enableAutomaticFailover}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn  Binding="{Binding location}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Location" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.LocationFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.LocationFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Public Net Access"  Binding="{Binding properties.publicNetworkAccess}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="Multiple Write Locations"  Binding="{Binding properties.enableMultipleWriteLocations}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="Partition Key Monitor"  Binding="{Binding properties.enablePartitionKeyMonitor}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="VNet Filter Enabled"  Binding="{Binding properties.isVirtualNetworkFilterEnabled}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="Analytical Storage"  Binding="{Binding properties.enableAnalyticalStorage}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="Partition Merge"  Binding="{Binding properties.enablePartitionMerge}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="Burst Capacity"  Binding="{Binding properties.enableBurstCapacity}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="Default Identity"  Binding="{Binding properties.defaultIdentity}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="Scanned By Purview"  Binding="{Binding IsScannedByPurview}"  local:DataGridExtensions.SortDesc="True" />


                            </DataGrid.Columns>

                            <DataGrid.RowDetailsTemplate>
                                <DataTemplate>

                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>

                                        <StackPanel Orientation="Horizontal">

                                            <Button x:Name="ViewPortalDbButton" Margin="8,4,2,4" Click="ViewPortalDbButton_Click" >
                                                <StackPanel Orientation="Horizontal" >
                                                    <Image Source="/AzureDataCosts;component/Images/azure.png" Style="{StaticResource ButtonImageStyle}"/>
                                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">Azure Portal</TextBlock>
                                                </StackPanel>
                                            </Button>

                                        </StackPanel>



                                        <DataGrid Grid.Row="1" ItemsSource="{Binding Path=Costs}" AutoGenerateColumns="false" CanUserAddRows="False" local:DataGridExtensions.SortDesc="True">
                                            <DataGrid.Columns>
                                                <DataGridTextColumn Header="Service" Binding="{Binding Path=ServiceName}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Meter" Binding="{Binding Path=Meter}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="MeterCategory" Binding="{Binding Path=MeterCategory}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="MeterSubCategory" Binding="{Binding Path=MeterSubCategory}" IsReadOnly="True"/>

                                                <DataGridTextColumn Header="Cost" Binding="{Binding Path=Cost, StringFormat={}{0:0.#0;(0);}}">
                                                    <DataGridTextColumn.CellStyle>
                                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Cost, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                                    <Setter Property="FontWeight" Value="Bold" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </DataGridTextColumn.CellStyle>
                                                </DataGridTextColumn>

                                                <DataGridTextColumn Header="ChargeType" Binding="{Binding Path=ChargeType}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Currency" Binding="{Binding Path=Currency}" IsReadOnly="True"/>
                                            </DataGrid.Columns>
                                        </DataGrid>

                                    </Grid>

                                </DataTemplate>
                            </DataGrid.RowDetailsTemplate>

                        </DataGrid>

                    </Grid>

                </busyIndicator:BusyMask>

            </mah:MetroTabItem>

            <mah:MetroTabItem Header="Data Factories" Name="TabDataFactories">

                <busyIndicator:BusyMask IsBusy="{Binding DFTabVm.IsADFQueryBusy, FallbackValue=False}" IndicatorType="{Binding BusyIndicatorType}"  BusyContent="Please wait..." >

                    <Grid Name="ADFLayoutGrid" IsVisibleChanged="ADFLayoutGrid_IsVisibleChanged" >
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="41*"/>
                            <ColumnDefinition Width="42*"/>
                            <ColumnDefinition Width="1118*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal" Margin="4,4,4,4" Grid.ColumnSpan="3">

                            <Button x:Name="DataFactoriesRefreshButton" Margin="10,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="DataFactoriesRefreshButton_Click">
                                <StackPanel Orientation="Horizontal" >

                                    <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                </StackPanel>
                            </Button>


                            <Button x:Name="DataFactoriesCollapseCostsButton" Margin="20,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="DataFactoriesCollapseCostsButton_Click">Show/Collapse Costs</Button>

                            <TextBlock Margin="30,2,2,2" FontSize="14" VerticalAlignment="Center">Total ADF Costs:</TextBlock>
                            <TextBlock Margin="4,2,2,2" FontSize="14" VerticalAlignment="Center" Text="{Binding DFTabVm.TotalCostsText}"></TextBlock>
                        </StackPanel>

                        <TextBlock Grid.Row="1" Padding="6" Margin="2,2,2,2" Text="{Binding DataFactoryErrorMessage}" MaxHeight="150" ToolTip="{Binding DataFactoryErrorMessage}" ToolTipService.InitialShowDelay="0" Visibility="{Binding IsDataFactoryErrorMessageVisible, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Hidden}" Background="Orange" Grid.ColumnSpan="3"></TextBlock>

                        <DataGrid Grid.Row="2" x:Name="DataFactoryDataGrid"
                              VirtualizingStackPanel.IsVirtualizing="true" 
                                EnableRowVirtualization ="True"
                              ItemsSource="{Binding Source={StaticResource DataFactoryDataGridViewSource}}" 
                              AutoGenerateColumns="False"
                              CanUserResizeRows="False"
                              FrozenColumnCount ="1"
                              RowHeight="20"
                                MouseUp="DataFactoryDataGrid_MouseUp"
                                KeyDown="DataFactoryDataGrid_KeyDown"  
                              RowDetailsVisibilityMode="Collapsed"
                                 local:DataGridExtensions.SortDesc="True"
                                  IsReadOnly="True" Grid.ColumnSpan="3"
                                  ScrollViewer.CanContentScroll="False"
                    >
                            <DataGrid.RowStyle>
                                <Style TargetType="{x:Type DataGridRow}">
                                    <EventSetter Event="MouseDoubleClick" Handler="RowDoubleClick"/>
                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="SelectRowDetails"/>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.CellStyle>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="BorderThickness" Value="0"/>
                                </Style>
                            </DataGrid.CellStyle>

                            <DataGrid.RowHeaderTemplate>
                                <DataTemplate>
                                    <Expander VerticalAlignment="Top" Margin="0" Padding="0" Expanded="Expander_Process"  Collapsed="Expander_Process">
                                    </Expander>
                                </DataTemplate>
                            </DataGrid.RowHeaderTemplate>

                            <DataGrid.Columns>

                                <DataGridTextColumn Header="Name" Binding="{Binding name}" CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn  Binding="{Binding resourceGroup}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Resource Group" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=DataFactoryDataGrid, Path=DataContext.DFTabVm.ResourceGroupFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=DataFactoryDataGrid, Path=DataContext.DFTabVm.ResourceGroupFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding Subscription.displayName}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Subscription" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
                        Foreground="DarkOrange"
                        Text="{Binding ElementName=DataFactoryDataGrid, Path=DataContext.DFTabVm.SubscriptionFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=DataFactoryDataGrid, Path=DataContext.DFTabVm.SubscriptionFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding location}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Location" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=DataFactoryDataGrid, Path=DataContext.DFTabVm.LocationFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=DataFactoryDataGrid, Path=DataContext.DFTabVm.LocationFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Cost (Bill CCY)" Binding="{Binding TotalCostBilling, StringFormat={}{0:0.#0;(0);}}"  >
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}" >
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TotalCostBilling, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>

                                            <Setter Property="Background" Value="LightGray"></Setter>
                                            <Setter Property="FontSize" Value="13"></Setter>

                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Created"  Binding="{Binding createdTime}" CellStyle="{StaticResource DataGridParentCell}" />
                                <DataGridTextColumn Header="Changed"  Binding="{Binding changedTime}" CellStyle="{StaticResource DataGridParentCell}" />

                            </DataGrid.Columns>

                            <DataGrid.RowDetailsTemplate>
                                <DataTemplate>

                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>

                                        <StackPanel Orientation="Horizontal">

                                            <Button x:Name="ViewPortalDbButton" Margin="8,4,2,4" Click="ViewPortalDbButton_Click" >
                                                <StackPanel Orientation="Horizontal" >
                                                    <Image Source="/AzureDataCosts;component/Images/azure.png" Style="{StaticResource ButtonImageStyle}"/>
                                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">Azure Portal</TextBlock>
                                                </StackPanel>
                                            </Button>

                                        </StackPanel>

                                        <DataGrid Grid.Row="1" ItemsSource="{Binding Path=Costs}" AutoGenerateColumns="false" CanUserAddRows="False" local:DataGridExtensions.SortDesc="True">
                                            <DataGrid.Columns>
                                                <DataGridTextColumn Header="Meter" Binding="{Binding Path=Meter}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Meter Category" Binding="{Binding Path=MeterCategory}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Meter SubCategory" Binding="{Binding Path=MeterSubCategory}" IsReadOnly="True"/>

                                                <DataGridTextColumn Header="Cost" Binding="{Binding Path=Cost, StringFormat={}{0:0.#0;(0);}}">
                                                    <DataGridTextColumn.CellStyle>
                                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Cost, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                                    <Setter Property="FontWeight" Value="Bold" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </DataGridTextColumn.CellStyle>
                                                </DataGridTextColumn>

                                                <DataGridTextColumn Header="ChargeType" Binding="{Binding Path=ChargeType}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Currency" Binding="{Binding Path=Currency}" IsReadOnly="True"/>
                                            </DataGrid.Columns>
                                        </DataGrid>

                                    </Grid>

                                </DataTemplate>
                            </DataGrid.RowDetailsTemplate>

                        </DataGrid>

                    </Grid>

                </busyIndicator:BusyMask>

            </mah:MetroTabItem>

            <mah:MetroTabItem Header="Storage" Name="TabStorage" Height="39" VerticalAlignment="Bottom">

                <busyIndicator:BusyMask IsBusy="{Binding StorageTabVm.IsStorageQueryBusy, FallbackValue=False}" IndicatorType="{Binding BusyIndicatorType}"  BusyContent="Please wait..." >

                    <Grid Name="StorageLayoutGrid" IsVisibleChanged="StorageLayoutGrid_IsVisibleChanged" >
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal" Margin="4">

                            <Button x:Name="StorageRefreshButton" Margin="10,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="StorageRefreshButton_Click">
                                <StackPanel Orientation="Horizontal" >

                                    <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                </StackPanel>
                            </Button>

                            <Button x:Name="StorageCollapseCostsButton" Margin="20,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="StorageCollapseCostsButton_Click">Show/Collapse Costs</Button>

                            <TextBlock Margin="30,2,2,2" FontSize="14" VerticalAlignment="Center">Total Storage Costs:</TextBlock>
                            <TextBlock Margin="4,2,2,2" FontSize="14" VerticalAlignment="Center" Text="{Binding StorageTabVm.TotalCostsText}"></TextBlock>
                        </StackPanel>

                        <TextBlock Grid.Row="1" Padding="6" Margin="2" Text="{Binding StorageErrorMessage}" MaxHeight="150" ToolTip="{Binding StorageErrorMessage}" ToolTipService.InitialShowDelay="0" Visibility="{Binding IsStorageErrorMessageVisible, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Hidden}" Background="Orange"></TextBlock>

                        <DataGrid Grid.Row="2" x:Name="StorageDataGrid"
                              VirtualizingStackPanel.IsVirtualizing="true" 
                                EnableRowVirtualization ="True"
                              ItemsSource="{Binding Source={StaticResource StorageDataGridViewSource}}" 
                              AutoGenerateColumns="False"
                              CanUserResizeRows="False"
                              FrozenColumnCount ="1"
                              RowHeight="20"
                                MouseUp="StorageDataGrid_MouseUp"
                                KeyDown="StorageDataGrid_KeyDown"  
                              RowDetailsVisibilityMode="Collapsed"
                                  IsReadOnly="True"
                                local:DataGridExtensions.SortDesc="True"
                                  ScrollViewer.CanContentScroll="False"
                    >
                            <DataGrid.RowStyle>
                                <Style TargetType="{x:Type DataGridRow}">
                                    <EventSetter Event="MouseDoubleClick" Handler="RowDoubleClick"/>
                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="SelectRowDetails"/>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.CellStyle>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="BorderThickness" Value="0"/>
                                </Style>
                            </DataGrid.CellStyle>

                            <DataGrid.RowHeaderTemplate>
                                <DataTemplate>
                                    <Expander VerticalAlignment="Top" Margin="0" Padding="0" Expanded="Expander_Process"  Collapsed="Expander_Process">
                                    </Expander>
                                </DataTemplate>
                            </DataGrid.RowHeaderTemplate>

                            <DataGrid.Columns>

                                <DataGridTextColumn Header="Name" Binding="{Binding name}" CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn  Binding="{Binding resourceGroup}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Resource Group" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.ResourceGroupFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.ResourceGroupFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding Subscription.displayName}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Subscription" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
                       Foreground="DarkOrange"
                       Text="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.SubscriptionFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.SubscriptionFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding location}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Location" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.LocationFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.LocationFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding sku.name}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Sku" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.SkuFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.SkuFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding sku.tier}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Tier" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.TierFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=StorageDataGrid, Path=DataContext.StorageTabVm.TierFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>


                                <DataGridTextColumn Header="Cost (Bill CCY)" Binding="{Binding TotalCostBilling, StringFormat={}{0:0.#0;(0);}}"  >
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}" >
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TotalCostBilling, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>

                                            <Setter Property="Background" Value="LightGray"></Setter>
                                            <Setter Property="FontSize" Value="13"></Setter>

                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Created"  Binding="{Binding properties.creationTime}" CellStyle="{StaticResource DataGridParentCell}" />

                            </DataGrid.Columns>

                            <DataGrid.RowDetailsTemplate>
                                <DataTemplate>

                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>

                                        <StackPanel Orientation="Horizontal">

                                            <Button x:Name="ViewPortalDbButton" Margin="8,4,2,4" Click="ViewPortalDbButton_Click" >
                                                <StackPanel Orientation="Horizontal" >
                                                    <Image Source="/AzureDataCosts;component/Images/azure.png" Style="{StaticResource ButtonImageStyle}"/>
                                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">Azure Portal</TextBlock>
                                                </StackPanel>
                                            </Button>

                                        </StackPanel>

                                        <DataGrid Grid.Row="1" ItemsSource="{Binding Path=Costs}" AutoGenerateColumns="false" CanUserAddRows="False" local:DataGridExtensions.SortDesc="True">
                                            <DataGrid.Columns>
                                                <DataGridTextColumn Header="Meter" Binding="{Binding Path=Meter}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Meter Category" Binding="{Binding Path=MeterCategory}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Meter SubCategory" Binding="{Binding Path=MeterSubCategory}" IsReadOnly="True"/>

                                                <DataGridTextColumn Header="Cost" Binding="{Binding Path=Cost, StringFormat={}{0:0.#0;(0);}}">
                                                    <DataGridTextColumn.CellStyle>
                                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Cost, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                                    <Setter Property="FontWeight" Value="Bold" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </DataGridTextColumn.CellStyle>
                                                </DataGridTextColumn>

                                                <DataGridTextColumn Header="ChargeType" Binding="{Binding Path=ChargeType}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Currency" Binding="{Binding Path=Currency}" IsReadOnly="True"/>
                                            </DataGrid.Columns>
                                        </DataGrid>

                                    </Grid>

                                </DataTemplate>
                            </DataGrid.RowDetailsTemplate>

                        </DataGrid>

                    </Grid>

                </busyIndicator:BusyMask>

            </mah:MetroTabItem>

            <mah:MetroTabItem Header="VNets" Name="TabVNets">

                <busyIndicator:BusyMask IsBusy="{Binding VNetTabVm.IsVNetQueryBusy, FallbackValue=False}" IndicatorType="{Binding BusyIndicatorType}"  BusyContent="Please wait..." >

                    <Grid Name="VNetLayoutGrid" IsVisibleChanged="VNetLayoutGrid_IsVisibleChanged">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal" Margin="4">

                            <Button x:Name="VNetRefreshButton" Margin="10,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="VNetsRefreshButton_Click">
                                <StackPanel Orientation="Horizontal" >

                                    <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                </StackPanel>
                            </Button>

                            <Button x:Name="VNetCollapseCostsButton" Margin="20,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="VNetCollapseCostsButton_Click">Show/Collapse Costs</Button>

                            <TextBlock Margin="30,2,2,2" FontSize="14" VerticalAlignment="Center">Total VNet Costs:</TextBlock>
                            <TextBlock Margin="4,2,2,2" FontSize="14" VerticalAlignment="Center" Text="{Binding VNetTabVm.TotalCostsText}"></TextBlock>
                        </StackPanel>

                        <TextBlock Grid.Row="1" Margin="2" 
                                   Style="{StaticResource WarningTextBlockStyle}"
                                   Text="{Binding VNetErrorMessage}" 
                                   MaxHeight="150" 
                                   ToolTip="{Binding VNetErrorMessage}" ToolTipService.InitialShowDelay="0" 
                                   Visibility="{Binding IsVNetErrorMessageVisible, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Hidden}" 
                                   ></TextBlock>

                        <DataGrid Grid.Row="2" x:Name="VNetDataGrid"
                              VirtualizingStackPanel.IsVirtualizing="true" 
                                EnableRowVirtualization ="True"
                              ItemsSource="{Binding Source={StaticResource VNetDataGridViewSource}}" 
                              AutoGenerateColumns="False"
                              CanUserResizeRows="False"
                              FrozenColumnCount ="1"
                              RowHeight="20"
                                MouseUp="VNetDataGrid_MouseUp"
                                KeyDown="VNetDataGrid_KeyDown"  
                              RowDetailsVisibilityMode="Collapsed"
                               local:DataGridExtensions.SortDesc="True"
                                  IsReadOnly="True"
                                  ScrollViewer.CanContentScroll="False"
                                
                    >
                            <DataGrid.RowStyle>
                                <Style TargetType="{x:Type DataGridRow}">
                                    <EventSetter Event="MouseDoubleClick" Handler="RowDoubleClick"/>
                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="SelectRowDetails"/>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.CellStyle>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="BorderThickness" Value="0"/>
                                </Style>
                            </DataGrid.CellStyle>

                            <DataGrid.RowHeaderTemplate>
                                <DataTemplate>
                                    <Expander VerticalAlignment="Top" Margin="0" Padding="0" Expanded="Expander_Process"  Collapsed="Expander_Process">
                                    </Expander>
                                </DataTemplate>
                            </DataGrid.RowHeaderTemplate>

                            <DataGrid.Columns>

                                <DataGridTextColumn Header="Name" Binding="{Binding name}" CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn  Binding="{Binding resourceGroup}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Resource Group" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=VNetDataGrid, Path=DataContext.VnetTabVm.ResourceGroupFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=VNetDataGrid, Path=DataContext.VnetTabVm.ResourceGroupFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding Subscription.displayName}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Subscription" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=VNetDataGrid, Path=DataContext.VNetTabVm.SubscriptionFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=VNetDataGrid, Path=DataContext.VNetTabVm.SubscriptionFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding location}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Location" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=VNetDataGrid, Path=DataContext.VNetTabVm.LocationFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=VNetDataGrid, Path=DataContext.VNetTabVm.LocationFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Cost (Bill CCY)" Binding="{Binding TotalCostBilling, StringFormat={}{0:0.#0;(0);}}"  >
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}" >
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TotalCostBilling, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>

                                            <Setter Property="Background" Value="LightGray"></Setter>
                                            <Setter Property="FontSize" Value="13"></Setter>

                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Sub Nets"  Binding="{Binding properties.subnets.Count}" CellStyle="{StaticResource DataGridParentCell}"  local:DataGridExtensions.SortDesc="True"/>
                                <DataGridTextColumn Header="VNet Peerings"  Binding="{Binding properties.virtualNetworkPeerings.Count}" CellStyle="{StaticResource DataGridParentCell}"  local:DataGridExtensions.SortDesc="True"/>

                            </DataGrid.Columns>

                            <DataGrid.RowDetailsTemplate>
                                <DataTemplate>

                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>

                                        <StackPanel Orientation="Horizontal">

                                            <Button x:Name="ViewPortalDbButton" Margin="8,4,2,4" Click="ViewPortalDbButton_Click" >
                                                <StackPanel Orientation="Horizontal" >
                                                    <Image Source="/AzureDataCosts;component/Images/azure.png" Style="{StaticResource ButtonImageStyle}"/>
                                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">Azure Portal</TextBlock>
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>

                                        <DataGrid Grid.Row="1" ItemsSource="{Binding Path=Costs}" AutoGenerateColumns="false" CanUserAddRows="False" local:DataGridExtensions.SortDesc="True">
                                            <DataGrid.Columns>
                                                <DataGridTextColumn Header="Meter" Binding="{Binding Path=Meter}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Meter Category" Binding="{Binding Path=MeterCategory}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Meter SubCategory" Binding="{Binding Path=MeterSubCategory}" IsReadOnly="True"/>


                                                <DataGridTextColumn Header="Cost" Binding="{Binding Path=Cost, StringFormat={}{0:0.#0;(0);}}">
                                                    <DataGridTextColumn.CellStyle>
                                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Cost, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                                    <Setter Property="FontWeight" Value="Bold" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </DataGridTextColumn.CellStyle>
                                                </DataGridTextColumn>

                                                <DataGridTextColumn Header="ChargeType" Binding="{Binding Path=ChargeType}" IsReadOnly="True"/>
                                                <DataGridTextColumn Header="Currency" Binding="{Binding Path=Currency}" IsReadOnly="True"/>
                                            </DataGrid.Columns>
                                        </DataGrid>

                                    </Grid>

                                </DataTemplate>
                            </DataGrid.RowDetailsTemplate>

                        </DataGrid>

                    </Grid>

                </busyIndicator:BusyMask>

            </mah:MetroTabItem>

            <mah:MetroTabItem Header="VMs" Name="TabVMs">

                <Grid Name="VMLayoutGrid" IsVisibleChanged="VMLayoutGrid_IsVisibleChanged" >
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" Margin="4">

                        <Button x:Name="VMRefreshButton" Margin="10,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="VMsRefreshButton_Click">
                            <StackPanel Orientation="Horizontal" >

                                <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                            </StackPanel>
                        </Button>

                        <Button x:Name="VMCollapseCostsButton" Margin="20,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="VMCollapseCostsButton_Click">Show/Collapse Costs</Button>

                        <TextBlock Margin="30,2,2,2" FontSize="14" VerticalAlignment="Center">Total VM Costs:</TextBlock>
                        <TextBlock Margin="4,2,2,2" FontSize="14" VerticalAlignment="Center" Text="{Binding VmTabVm.TotalCostsText}"></TextBlock>


                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="4" Grid.Row="1">

                        <Button x:Name="VMAnalyseSpendButton" Margin="10,2,2,2" Padding="8,1,8,1" Click="VMAnalyseSpendButton_Click" Content="Analyse Spend"/>

                        <Image gif:ImageBehavior.AnimatedSource="/Images/loading.gif" 
                               Margin="8,0,0,0" 
                               Style="{StaticResource LoadingGifStyle}"
                               Visibility="{Binding VmTabVm.IsVmSpendAnalysisBusy,Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Image.LayoutTransform>
                                <ScaleTransform ScaleX="0.8" ScaleY="0.8" />
                            </Image.LayoutTransform>
                        </Image>

                        <TextBlock Margin="30,2,2,2" FontSize="14" VerticalAlignment="Center" Visibility="{Binding VmTabVm.HasVmSpendAnalysisBeenPerformed, Converter={ StaticResource BooleanToVisibilityConverter}}">Total Potential Saving:</TextBlock>
                        <TextBlock Margin="4,2,2,2" FontSize="14" VerticalAlignment="Center" Text="{Binding VmTabVm.TotalPotentialVmSavingAmount, StringFormat=N0}" Visibility="{Binding VmTabVm.HasVmSpendAnalysisBeenPerformed, Converter={ StaticResource BooleanToVisibilityConverter}}"></TextBlock>


                    </StackPanel>

                    <TextBlock Grid.Row="2" Margin="2" 
                               Style="{StaticResource WarningTextBlockStyle}" 
                               Text="{Binding VMErrorMessage}" 
                               MaxHeight="150" 
                               ToolTip="{Binding VMErrorMessage}" ToolTipService.InitialShowDelay="0" 
                               Visibility="{Binding IsVMErrorMessageVisible, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Hidden}"></TextBlock>

                    <busyIndicator:BusyMask Grid.Row="3" Name="VmBusyMask" IsBusy="{Binding VmTabVm.IsVMQueryBusy, FallbackValue=False}" IndicatorType="{Binding BusyIndicatorType}"  BusyContent="Please wait..." >

                        <DataGrid x:Name="VMDataGrid"                              
                              ItemsSource="{Binding Source={StaticResource VMDataGridViewSource}}"                               
                              FrozenColumnCount ="1"                             
                                MouseUp="VMDataGrid_MouseUp"
                                KeyDown="VMDataGrid_KeyDown"                                
                                  LoadingRowDetails="VMDataGrid_LoadingRowDetails"
                               local:DataGridExtensions.SortDesc="True" 
                                  ScrollViewer.CanContentScroll="False"
                    >
                            <DataGrid.RowStyle>
                                <Style TargetType="{x:Type DataGridRow}">
                                    <EventSetter Event="MouseDoubleClick" Handler="RowDoubleClick"/>
                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="SelectRowDetails"/>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.CellStyle>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="BorderThickness" Value="0"/>
                                </Style>
                            </DataGrid.CellStyle>

                            <DataGrid.RowHeaderTemplate>
                                <DataTemplate>
                                    <Expander VerticalAlignment="Top" Margin="0" Padding="0" Expanded="Expander_Process"  Collapsed="Expander_Process">
                                    </Expander>
                                </DataTemplate>
                            </DataGrid.RowHeaderTemplate>

                            <DataGrid.Columns>

                                <DataGridTextColumn Header="VM Name" Binding="{Binding name}" CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn  Binding="{Binding resourceGroup}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Resource Group" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=VMDataGrid, Path=DataContext.VmTabVm.ResourceGroupFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=VMDataGrid, Path=DataContext.VmTabVm.ResourceGroupFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding Subscription.displayName}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Subscription" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=VMDataGrid, Path=DataContext.VmTabVm.SubscriptionFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=VMDataGrid, Path=DataContext.VmTabVm.SubscriptionFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Size"  Binding="{Binding properties.hardwareProfile.vmSize}"  CellStyle="{StaticResource DataGridParentCell}"  local:DataGridExtensions.SortDesc="True"/>

                                <!--<DataGridTextColumn Header="Computer Name"  Binding="{Binding properties.osProfile.computerName}"  CellStyle="{StaticResource DataGridParentCell}" />-->


                                <DataGridTextColumn  Binding="{Binding location}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Location" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=VMDataGrid, Path=DataContext.VmTabVm.LocationFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=VMDataGrid, Path=DataContext.VmTabVm.LocationFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Cost (Bill CCY)" Binding="{Binding TotalCostBilling, StringFormat={}{0:0.#0;(0);}}"  >
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}" >
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TotalCostBilling, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                    <Setter Property="Foreground" Value="OrangeRed" />
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                </DataTrigger>
                                            </Style.Triggers>

                                            <Setter Property="Background" Value="LightGray"></Setter>
                                            <Setter Property="FontSize" Value="13"></Setter>

                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Over Provision%"  Binding="{Binding OverSpendFromMaxPc, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}" local:DataGridExtensions.SortDesc="True" />
                                <DataGridTextColumn Header="Potential Saving"  Binding="{Binding PotentialSavingAmount, StringFormat=N0}" CellStyle="{StaticResource NumericGridCellStyle}" local:DataGridExtensions.SortDesc="True" />

                            </DataGrid.Columns>

                            <DataGrid.RowDetailsTemplate>
                                <DataTemplate>

                                    <mah:MetroAnimatedSingleRowTabControl Name="VMTabControl" SelectionChanged="VMTabControl_SelectionChanged" Margin="0,0,0,30" >

                                        <mah:MetroTabItem Header="Useage" Name="TabVMUseage">

                                            <Grid Style="{StaticResource SubSectionGrid}">


                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="*"/>
                                                    </Grid.RowDefinitions>

                                                    <!--<Border BorderThickness="0,0,0,1" BorderBrush="Gray">
                                                        <StackPanel Orientation="Horizontal" Margin="2">
                                                            <TextBlock Margin="2" FontSize="16" VerticalAlignment="Center">VM Usage</TextBlock>

                                                        </StackPanel>
                                                    </Border>-->

                                                    <StackPanel Orientation="Horizontal" Margin="2" Grid.Row="1">
                                                        <TextBox Height="22" Width="30" VerticalContentAlignment="Center" Padding="0" VerticalAlignment="Center" Margin="10,2,2,2" 
                                                         Text="{Binding MetricsHistoryDays, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                         MouseDoubleClick="NonGridExpandingTextBox_MouseDoubleClick"
                                                         PreviewMouseDoubleClick="NonGridExpandingTextBox_MouseDoubleClick"
                                                         ></TextBox>
                                                        <TextBlock Margin="4,2,2,2" Text="Days" VerticalAlignment="Center"></TextBlock>

                                                        <Button x:Name="RefreshVmStatsButton" Margin="8,2,2,2" Click="RefreshVmStatsButton_Click">
                                                            <StackPanel Orientation="Horizontal" >

                                                                <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                                                <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                                            </StackPanel>
                                                        </Button>

                                                        <Button x:Name="ViewPortalDbButton" Margin="8,4,2,4" Click="ViewPortalDbButton_Click" >
                                                            <StackPanel Orientation="Horizontal" >
                                                                <Image Source="/AzureDataCosts;component/Images/azure.png" Style="{StaticResource ButtonImageStyle}"/>
                                                                <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">Azure Portal</TextBlock>
                                                            </StackPanel>
                                                        </Button>

                                                    </StackPanel>


                                                    <StackPanel Orientation="Horizontal" Margin="2" Grid.Row="2">
                                                        <TextBlock Margin="2">Max CPU % found:</TextBlock>
                                                        <TextBlock Margin="2" Text="{Binding MaxCpuUsed}"></TextBlock>

                                                        <TextBlock Margin="30,2,2,2" Text="{Binding MetricsErrorMessage}"></TextBlock>
                                                    </StackPanel>

                                                    <busyIndicator:BusyMask Grid.Row="3"
                                            IsBusy="{Binding IsRestQueryBusy, FallbackValue=False}" 
                                            IndicatorType="{Binding BusyIndicatorType}"
                                            BusyContent="Please wait..." >


                                                        <oxycontrols:Plot Height="150" Width="300" VerticalAlignment="Top" >

                                                            <oxycontrols:Plot.Legends>
                                                                <oxycontrols:Legend LegendPosition="RightMiddle" LegendPlacement="Outside" />
                                                            </oxycontrols:Plot.Legends>

                                                            <oxycontrols:Plot.Series>

                                                                <oxycontrols:LineSeries DisplayMemberPath="maximum" 
                                                             Style="{StaticResource MaxLineSeriesStyle}"
                                                             DataFieldX="timeStamp" 
                                                             DataFieldY="maximum"
                                                             ItemsSource="{Binding PerformanceMetricSeries}"/>

                                                                <oxycontrols:LineSeries DisplayMemberPath="average" 
                                                             DataFieldX="timeStamp" 
                                                             DataFieldY="average"
                                                             Style="{StaticResource AvgLineSeriesStyle}"
                                                             ItemsSource="{Binding PerformanceMetricSeries}"/>


                                                            </oxycontrols:Plot.Series>

                                                            <oxycontrols:Plot.Axes>
                                                                <oxycontrols:LinearAxis Position="Left" Minimum="0" Maximum="100" />
                                                                <oxycontrols:DateTimeAxis Position="Bottom"/>
                                                            </oxycontrols:Plot.Axes>
                                                        </oxycontrols:Plot>

                                                    </busyIndicator:BusyMask>
                                                </Grid>


                                               

                                            </Grid>
                                        </mah:MetroTabItem>

                                        <mah:MetroTabItem Header="Costs" Name="TabVMCosts">

                                            <Grid Style="{StaticResource SubSectionGrid}">
                                                <Grid Grid.Column="1" >
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="*"/>
                                                    </Grid.RowDefinitions>

                                                    <!--<Border BorderThickness="0,0,0,1" BorderBrush="Gray">
                                                        <StackPanel Orientation="Horizontal" Margin="2,2,2,2">
                                                            <TextBlock Margin="2" FontSize="16" VerticalAlignment="Center">Costs</TextBlock>

                                                        </StackPanel>
                                                    </Border>-->

                                                    <DataGrid ItemsSource="{Binding Path=Costs}" Grid.Row="1" AutoGenerateColumns="false" CanUserAddRows="False" local:DataGridExtensions.SortDesc="True">
                                                        <DataGrid.Columns>
                                                            <DataGridTextColumn Header="Meter" Binding="{Binding Path=Meter}" IsReadOnly="True"/>
                                                            <DataGridTextColumn Header="Meter Category" Binding="{Binding Path=MeterCategory}" IsReadOnly="True"/>
                                                            <DataGridTextColumn Header="Meter SubCategory" Binding="{Binding Path=MeterSubCategory}" IsReadOnly="True"/>


                                                            <DataGridTextColumn Header="Cost" Binding="{Binding Path=Cost, StringFormat={}{0:0.#0;(0);}}">
                                                                <DataGridTextColumn.CellStyle>
                                                                    <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Cost, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                                                <Setter Property="Foreground" Value="OrangeRed" />
                                                                                <Setter Property="FontWeight" Value="Bold" />
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </DataGridTextColumn.CellStyle>
                                                            </DataGridTextColumn>

                                                            <DataGridTextColumn Header="ChargeType" Binding="{Binding Path=ChargeType}" IsReadOnly="True"/>
                                                            <DataGridTextColumn Header="Currency" Binding="{Binding Path=Currency}" IsReadOnly="True"/>
                                                        </DataGrid.Columns>
                                                    </DataGrid>

                                                </Grid>
                                            </Grid>

                                        </mah:MetroTabItem>

                                    </mah:MetroAnimatedSingleRowTabControl>
                                    
                                </DataTemplate>
                            </DataGrid.RowDetailsTemplate>

                        </DataGrid>

                    </busyIndicator:BusyMask>

                </Grid>

            </mah:MetroTabItem>

            <mah:MetroTabItem Header="Purview" Name="TabPurview">

                <busyIndicator:BusyMask IsBusy="{Binding PurviewTabVm.IsPurviewQueryBusy, FallbackValue=False}" 
                                        IndicatorType="{Binding BusyIndicatorType}"  
                                        BusyContent="Please wait..."
                                        
                                        >

                    <Grid Name="PurviewLayoutGrid" IsVisibleChanged="PurviewLayoutGrid_IsVisibleChanged">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="47*"/>
                            <ColumnDefinition Width="1153*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal" Margin="4,4,4,4" Grid.ColumnSpan="2">

                            <Button x:Name="PurviewRefreshButton" Margin="10,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="PurviewRefreshButton_Click">
                                <StackPanel Orientation="Horizontal" >

                                    <Image Source="/AzureDataCosts;component/Images/refresh.png" Style="{StaticResource ButtonImageStyle}"/>
                                    <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">REFRESH</TextBlock>
                                </StackPanel>
                            </Button>

                            <Button x:Name="PurviewCollapseCostsButton" Margin="20,2,2,2" Padding="8,1,8,1" VerticalAlignment="Center" Click="PurviewCollapseCostsButton_Click">Show/Collapse Costs</Button>

                            <TextBlock Margin="30,2,2,2" FontSize="14" VerticalAlignment="Center">Total Purview Costs:</TextBlock>
                            <TextBlock Margin="4,2,2,2" FontSize="14" VerticalAlignment="Center" Text="{Binding PurviewTabVm.TotalCostsText}"></TextBlock>
                        </StackPanel>

                        <TextBlock Grid.Row="1" 
                                   Margin="2,2,2,2" Grid.ColumnSpan="2" 
                                   Style="{StaticResource WarningTextBlockStyle}"
                                   Text="{Binding VMErrorMessage}" 
                                   MaxHeight="150" 
                                   ToolTip="{Binding VMErrorMessage}" ToolTipService.InitialShowDelay="0" 
                                   Visibility="{Binding IsVMErrorMessageVisible, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Hidden}" 
                                   ></TextBlock>

                        <DataGrid Grid.Row="2" x:Name="PurviewDataGrid"
                              VirtualizingStackPanel.IsVirtualizing="true" 
                                EnableRowVirtualization ="True"
                              ItemsSource="{Binding Source={StaticResource PurviewDataGridViewSource}}" 
                              AutoGenerateColumns="False"
                              CanUserResizeRows="False"
                              FrozenColumnCount ="1"
                              RowHeight="20"
                                MouseUp="VMDataGrid_MouseUp"
                                KeyDown="VMDataGrid_KeyDown"  
                              RowDetailsVisibilityMode="Collapsed"
                                  IsReadOnly="True" Grid.ColumnSpan="2"
                                local:DataGridExtensions.SortDesc="True"
                    >
                            <DataGrid.RowStyle>
                                <Style TargetType="{x:Type DataGridRow}">
                                    <EventSetter Event="MouseDoubleClick" Handler="RowDoubleClick"/>
                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="SelectRowDetails"/>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.CellStyle>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="BorderThickness" Value="0"/>
                                </Style>
                            </DataGrid.CellStyle>

                            <DataGrid.RowHeaderTemplate>
                                <DataTemplate>
                                    <Expander VerticalAlignment="Top" Margin="0" Padding="0" Expanded="Expander_Process"  Collapsed="Expander_Process">
                                    </Expander>
                                </DataTemplate>
                            </DataGrid.RowHeaderTemplate>

                            <DataGrid.Columns>

                                <DataGridTextColumn Header="Name" Binding="{Binding name}" CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn  Binding="{Binding resourceGroup}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Resource Group" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.ResourceGroupFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.ResourceGroupFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn  Binding="{Binding Subscription.displayName}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Subscription" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.SubscriptionFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.SubscriptionFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Capacity Size"  Binding="{Binding sku.capacity}"  CellStyle="{StaticResource DataGridParentCell}" />

                                <DataGridTextColumn Header="Capacity Name"  Binding="{Binding sku.name}"  CellStyle="{StaticResource DataGridParentCell}" />


                                <DataGridTextColumn  Binding="{Binding location}" CellStyle="{StaticResource DataGridParentCell}" >
                                    <DataGridTextColumn.HeaderTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="Location" VerticalAlignment="Center" Margin="0,0,4,0"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <!--Note Binding ElementName=RestDbDataGrid is used to get data context-->
                                                    <TextBlock Margin="1" VerticalAlignment="Center" 
Foreground="DarkOrange"
Text="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.LocationFilter.SummaryText}">
                                                    </TextBlock>

                                                    <Button DataContext="{Binding ElementName=PurviewDataGrid, Path=DataContext.PurviewTabVm.LocationFilter.Items}" Click="ColumnFilterButton_Click" Height="10" Width="20" Padding="0" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="/AzureDataCosts;component/Images/filter.png" Height="11"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>

                                            </Grid>

                                        </DataTemplate>
                                    </DataGridTextColumn.HeaderTemplate>
                                </DataGridTextColumn>


                                <DataGridTextColumn Header="Public Net Access"  Binding="{Binding properties.publicNetworkAccess}"  CellStyle="{StaticResource DataGridParentCell}" />


                            </DataGrid.Columns>

                            <DataGrid.RowDetailsTemplate>
                                <DataTemplate>

                                    <mah:MetroAnimatedSingleRowTabControl Name="PurviewTabControl" SelectionChanged="PurviewTabControl_SelectionChanged" >

                                        <mah:MetroTabItem Header="Costs" Name="TabPurviewCosts">

                                            <Grid Name="PurviewCostsGrid">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>

                                                <StackPanel Orientation="Horizontal">

                                                    <Button x:Name="ViewPortalDbButton" Margin="8,4,2,4" Click="ViewPortalDbButton_Click" >
                                                        <StackPanel Orientation="Horizontal" >
                                                            <Image Source="/AzureDataCosts;component/Images/azure.png" Style="{StaticResource ButtonImageStyle}"/>
                                                            <TextBlock Margin="3,0,0,0" VerticalAlignment="Center">Azure Portal</TextBlock>
                                                        </StackPanel>
                                                    </Button>

                                                </StackPanel>



                                                <DataGrid Grid.Row="1" ItemsSource="{Binding Path=Costs}" AutoGenerateColumns="false" CanUserAddRows="False" local:DataGridExtensions.SortDesc="True">
                                                    <DataGrid.Columns>
                                                        <DataGridTextColumn Header="Service" Binding="{Binding Path=ServiceName}" IsReadOnly="True"/>
                                                        <DataGridTextColumn Header="Product" Binding="{Binding Path=Product}" IsReadOnly="True"/>
                                                        <DataGridTextColumn Header="Meter" Binding="{Binding Path=Meter}" IsReadOnly="True"/>


                                                        <DataGridTextColumn Header="Cost" Binding="{Binding Path=Cost, StringFormat={}{0:0.#0;(0);}}">
                                                            <DataGridTextColumn.CellStyle>
                                                                <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource NumericGridCellStyle}">
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding Cost, Converter={StaticResource NonZeroNumberToBooleanConverter}, ConverterParameter=1, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" Value="True">
                                                                            <Setter Property="Foreground" Value="OrangeRed" />
                                                                            <Setter Property="FontWeight" Value="Bold" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </DataGridTextColumn.CellStyle>
                                                        </DataGridTextColumn>

                                                        <DataGridTextColumn Header="ChargeType" Binding="{Binding Path=ChargeType}" IsReadOnly="True"/>
                                                        <DataGridTextColumn Header="Currency" Binding="{Binding Path=Currency}" IsReadOnly="True"/>
                                                    </DataGrid.Columns>
                                                </DataGrid>

                                            </Grid>

                                        </mah:MetroTabItem>

                                        <mah:MetroTabItem Header="Data Sources" Name="TabPurviewDataSources">

                                            <Grid Name="PurviewDataSourcesGrid">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>

                                                <ScrollViewer>
                                                <DataGrid Grid.Row="0" MaxHeight="500" VerticalScrollBarVisibility="Visible" ItemsSource="{Binding Path=DataSourceGridRows}" AutoGenerateColumns="false" CanUserAddRows="False" local:DataGridExtensions.SortDesc="True">
                                                    <DataGrid.Columns>
                                                            <DataGridTextColumn Header="Data Source" Binding="{Binding Path=DsName}" IsReadOnly="True"/>
                                                            <DataGridTextColumn Header="Kind" Binding="{Binding Path=DsKind}" IsReadOnly="True"/>
                                                            <DataGridTextColumn Header="ScanName" Binding="{Binding Path=ScanName}" IsReadOnly="True"/>
                                                            <DataGridTextColumn Header="End Point" Binding="{Binding Path=DsEndPoint}" IsReadOnly="True"/>
                                                            <DataGridTextColumn Header="Database" Binding="{Binding Path=ScanDatabaseName}" IsReadOnly="True"/>
                                                        
                                                            <!--<DataGridTextColumn Header="DsResourceName" Binding="{Binding Path=DsResourceName}" IsReadOnly="True"/>-->
                                                            <!--<DataGridTextColumn Header="ScanEndpoint" Binding="{Binding Path=ScanEndpoint}" IsReadOnly="True"/>-->                                                            
                                                    </DataGrid.Columns>
                                                </DataGrid>
                                                </ScrollViewer>
                                            </Grid>

                                        </mah:MetroTabItem>


                                    </mah:MetroAnimatedSingleRowTabControl>

                                </DataTemplate>
                            </DataGrid.RowDetailsTemplate>

                        </DataGrid>

                    </Grid>

                </busyIndicator:BusyMask>

            </mah:MetroTabItem>

            

        </mah:MetroAnimatedSingleRowTabControl>


        <StatusBar Grid.Row="1" Background="LightGray" Foreground="DimGray">
            <StatusBarItem>
                <TextBlock Margin="2" Text="{Binding HttpAccessCountMessage}"></TextBlock>
            </StatusBarItem>

            <StatusBarItem>
                <TextBlock Margin="12,2,2,2">Limit: 12,000 per subscription/user/hour</TextBlock>
            </StatusBarItem>

            <Separator Width="1" Background="Gray" Margin="10,3,10,3"></Separator>

            <StatusBarItem>

                <TextBlock Foreground="DarkBlue" Cursor="Hand" MouseLeftButtonUp="StatusSelectionText_MouseLeftButtonUp" Margin="2" Text="{Binding SelectSubscriptionsCountMessage}"></TextBlock>
            </StatusBarItem>

        </StatusBar>


        <Grid.Resources>


        </Grid.Resources>


    </Grid>
</mah:MetroWindow>
